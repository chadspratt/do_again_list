<!DOCTYPE html>
<html>
<head>
    <title>Do Again List</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #333; padding: 20px; }

        /* Header */
        .header { background: #fff; border-radius: 8px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8rem; }

        /* Messages */
        .messages { margin-bottom: 16px; }
        .messages .success { background: #d4edda; color: #155724; padding: 10px 14px; border-radius: 6px; margin-bottom: 6px; }
        .messages .error { background: #f8d7da; color: #721c24; padding: 10px 14px; border-radius: 6px; margin-bottom: 6px; }

        /* Buttons */
        .btn { display: inline-block; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: .85rem; text-decoration: none; color: #fff; }
        .btn-primary { background: #0d6efd; }
        .btn-primary:hover { background: #0b5ed7; }
        .btn-success { background: #198754; }
        .btn-success:hover { background: #157347; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #bb2d3b; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 6px 12px; font-size: .8rem; }

        /* Modal / forms */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.4); z-index: 100; justify-content: center; align-items: flex-start; padding-top: 80px; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: 10px; padding: 24px; width: 500px; max-width: 95vw; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 30px rgba(0,0,0,.2); }
        .modal h2 { margin-bottom: 16px; font-size: 1.2rem; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: .85rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: .9rem; }
        .form-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

        /* Events Grid */
        .events-container { max-width: 1500px; margin: 0 auto; }
        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(236px, 1fr)); gap: 16px; }
        .event-card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.1); border-left: 4px solid #0d6efd; position: relative; }
        .event-card .event-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: #1a1a1a; padding-right: 30px; }
        .event-card .event-date { font-size: .85rem; color: #666; margin-bottom: 12px; }
        .event-card .event-timer { font-size: 1.5rem; font-weight: 700; color: #0d6efd; margin-bottom: 16px; min-height: 36px; }
        .event-card .event-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .event-card .event-actions input[type="text"] { flex: 1; min-width: 100px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: .8rem; }
        .event-card .delete-icon { position: absolute; top: 12px; right: 12px; cursor: pointer; font-size: 1.2rem; opacity: 0.5; transition: opacity 0.2s; }
        .event-card .delete-icon:hover { opacity: 1; }
        .events-empty { text-align: center; color: #999; padding: 60px 20px; font-size: 1.1rem; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
    </style>
</head>
<body>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="{{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<!-- Header -->
<div class="header">
    <h1>‚è±Ô∏è Do Again List</h1>
    <button class="btn btn-primary" onclick="document.getElementById('newEventModal').classList.add('active')">+ Add Event</button>
</div>

<!-- Events Grid -->
<div class="events-container">
    <div class="events-grid" id="eventsList">
        {% if events %}
        {% for event in events %}
        <div class="event-card" data-event-id="{{ event.id }}" data-event-date="{{ event.date.isoformat }}">
            <span class="delete-icon" onclick="deleteEvent({{ event.id }})" title="Delete event">üóëÔ∏è</span>
            <div class="event-title">{{ event.title }}</div>
            <div class="event-date" data-date-display="{{ event.id }}"></div>
            <div class="event-timer" data-timer="{{ event.id }}"></div>
            <div class="event-actions">
                <input type="text" placeholder="e.g. 1h30m" id="updateInput{{ event.id }}">
                <button class="btn btn-primary btn-sm" onclick="updateEventToNow({{ event.id }})">Update</button>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="events-empty">No events yet. Click "Add Event" to create your first one.</div>
        {% endif %}
    </div>
</div>

<!-- New Event Modal -->
<div class="modal-overlay" id="newEventModal" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="modal">
        <h2>Add Past Event</h2>
        <form method="post" action="{% url 'do_again_create_event' %}" id="eventForm" onsubmit="return handleEventSubmit(event)">
            {% csrf_token %}
            <div class="form-group">
                <label>Title *</label>
                <input type="text" name="title" required placeholder="e.g. Started learning Python" autofocus>
            </div>
            <div class="form-group">
                <label>Time Ago</label>
                <input type="text" name="time_ago" id="eventTimeInput" placeholder="Leave blank for now, or e.g. 1h30m, 2h, 45m">
                <input type="hidden" name="date" id="eventDateHidden">
                <small style="color: #666; font-size: 0.8rem; display: block; margin-top: 4px;">Examples: blank = now, 1h = 1 hour ago, 1h30m = 1 hour 30 min ago, 2d = 2 days ago</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').classList.remove('active')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Event</button>
            </div>
        </form>
    </div>
</div>

<script>
// Format dates in browser's local timezone
(function() {
    document.querySelectorAll('[data-date-display]').forEach(el => {
        const eventCard = el.closest('.event-card');
        const eventDate = new Date(eventCard.dataset.eventDate);
        
        // Format: "Feb 11, 2026, 3:45 PM"
        const options = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        };
        el.textContent = eventDate.toLocaleString('en-US', options);
    });
})();

// Event timer updates
(function() {
    function updateTimers() {
        document.querySelectorAll('[data-timer]').forEach(el => {
            const eventCard = el.closest('.event-card');
            const eventDate = new Date(eventCard.dataset.eventDate);
            const now = new Date();
            const diff = now - eventDate;
            
            if (diff < 0) {
                el.textContent = 'Future event';
                return;
            }
            
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            
            if (days > 365) {
                const years = Math.floor(days / 365);
                const remainingDays = days % 365;
                el.textContent = years + 'y ' + remainingDays + 'd ago';
            } else if (days > 0) {
                el.textContent = days + 'd ' + hours + 'h ago';
            } else if (hours > 0) {
                el.textContent = hours + 'h ' + mins + 'm ago';
            } else if (mins > 0) {
                el.textContent = mins + 'm ' + secs + 's ago';
            } else {
                el.textContent = secs + 's ago';
            }
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);
})();

function updateEventToNow(eventId) {
    const timeInput = document.getElementById('updateInput' + eventId).value;
    const calculatedDate = parseTimeOffset(timeInput);
    
    fetch('/do_again/event/' + eventId + '/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            datetime: calculatedDate.toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear all update input fields
            document.querySelectorAll('[id^="updateInput"]').forEach(input => {
                input.value = '';
            });
            location.reload();
        } else {
            alert('Error updating event');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating event');
    });
}

function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event?')) {
        return;
    }
    
    fetch('/do_again/event/' + eventId + '/delete/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error deleting event');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting event');
    });
}

// Parse time offset input and calculate datetime
function parseTimeOffset(input) {
    if (!input || input.trim() === '') {
        return new Date();
    }
    
    const now = new Date();
    let totalMs = 0;
    
    // Parse patterns like "1h30m", "2h", "45m", "2d", "1d5h30m"
    const dayMatch = input.match(/(\d+)d/);
    const hourMatch = input.match(/(\d+)h/);
    const minMatch = input.match(/(\d+)m/);
    const secMatch = input.match(/(\d+)s/);
    
    if (dayMatch) totalMs += parseInt(dayMatch[1]) * 24 * 60 * 60 * 1000;
    if (hourMatch) totalMs += parseInt(hourMatch[1]) * 60 * 60 * 1000;
    if (minMatch) totalMs += parseInt(minMatch[1]) * 60 * 1000;
    if (secMatch) totalMs += parseInt(secMatch[1]) * 1000;
    
    return new Date(now - totalMs);
}

function handleEventSubmit(event) {
    event.preventDefault();
    
    const timeInput = document.getElementById('eventTimeInput').value;
    const calculatedDate = parseTimeOffset(timeInput);
    
    // Format for Django: ISO format
    const dateHidden = document.getElementById('eventDateHidden');
    dateHidden.value = calculatedDate.toISOString();
    
    // Submit the form
    event.target.submit();
    return false;
}

// Auto-focus on modal open
document.getElementById('newEventModal').addEventListener('transitionend', function(e) {
    if (this.classList.contains('active')) {
        this.querySelector('input[name="title"]').focus();
    }
});
</script>

</body>
</html>
